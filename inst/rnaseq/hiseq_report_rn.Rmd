---
title: "HiSeq report"
author: "Ming Wang"
date: "`r Sys.Date()`"
output:
  html_document:
    highlight: tango
    toc: yes
    toc_float:
      collapsed: no
    keep_md: false
  word_document:
    toc: yes
  pdf_document:
    toc: yes
params:
  input_dir: ""
---

```{r setup, include=FALSE}
suppressPackageStartupMessages(library(knitr))

knitr::opts_chunk$set(fig.width  = 12, 
                      fig.height = 8, 
                      fig.path   = "Figures/",
                      eval       = TRUE,
                      echo       = FALSE,
                      cache      = FALSE,
                      prompt     = FALSE,
                      tidy       = FALSE,
                      comment    = NA,
                      message    = FALSE,
                      warning    = FALSE,
                      eval       = T,
                      rownames.print = FALSE)
```


```{r load pkg}
library(hiseqr)
library(knitr)
library(ggplot2)
library(dplyr)
library(glue)
library(DT)
```


```{r init project, eval = T}
input_dir  <- params$input_dir
# input_dir  <- "/data/yulab/wangming/work/devel_pipeline/hiseq/rnaseq/results/rnaseq_se/RNAseq_I_R_Hybrid_Dys_6h"
input_dir  <- normalizePath(input_dir)
if(! is_hiseq_dir(input_dir, "rnaseq_rn")) {
  stop(paste0("Not a RNAseq single directory, _rn: ", input_dir))
}
```

## Config data

```{r config, eval = T, results = "asis"}
is_paired <- all(list_hiseq_file(input_dir, "is_paired", "r1"))
n_samples <- length(list_hiseq_file(input_dir, "rep_list", "_rn"))
genome    <- list_hiseq_file(input_dir, "genome", "_rn")
organism  <- genome
gtf       <- list_hiseq_file(input_dir, "gene_gtf", "_rn")
smp_name  <- list_hiseq_file(input_dir, "smp_name", "_rn")
is_mut    <- list_hiseq_file(input_dir, "is_mut", "_rn")
project_name <- list_hiseq_file(input_dir, "project_name", "_rn")

msg <- glue::glue(
  "   smp_name: {smp_name}; ",
  "     genome: {genome}; ",
  "     is_mut: {is_mut}; ",
  " paired-end: {is_paired}",
  "project_dir: {project_name}",
  .sep = "\n"
)
print(msg)
```


```{r plot_data}
df_trim_stat  <- read_hiseq_trim_stat(input_dir)
df_align_stat <- read_hiseq_align_stat(input_dir)
```


## 1 Summary

```{r summary, results="asis"}
n_smp      <- length(list_hiseq_file(input_dir, "rep_list", "_rn"))
total      <- df_align_stat %>% pull(total) %>% mean()
map        <- df_align_stat %>% pull(map) %>% mean()
map_pct    <- round(map / total * 100, 1) %>% mean()
unique_m   <- df_align_stat %>% pull(unique) %>% mean()
unique_pct <- round(unique_m / total * 100, 1) %>% mean()
total    <- round(total / 1e6, 1) # Million
map      <- round(map / 1e6, 1) # Million
unique_m <- round(unique_m / 1e6, 1) # Million
sum_text <- glue::glue("A total of {n_smp} samples; {total}M sequencing depth; ",
    "with {map}M ({map_pct}%) reads mapped to reference genome, including ",
    "{unique_m}M ({unique_pct}%) unique mapped.")

print(sum_text)
```


## 2 Results


### 2.1 Table1. number of reads

```{r table1_mito_pct}
hiseqr::to_DT(df_align_stat)
```


### 2.2 Figure 1. Number of mapped reads

+ Clean data percentage

```{r figure1_trim_reads, out.width = "100%", fig.height = 3}
plot_hiseq_trim(input_dir)
```

+ Map percentage

```{r figure1_align_reads, fig.height = 3}
plot_hiseq_align(input_dir, columns = c("map", "rRNA", "spikein", "unmap"))
```

+ Unique percentage

```{r figure1_unique_reads, fig.height = 3}
plot_hiseq_align(input_dir, columns = c("unique", "multi", "unmap"))
```


### 2.3 RNAseq library type

Check the RNAseq library type, check if the reads from forward strand or reverse strand of mRNA;

Using `featureCounts` to count reads on mRNAs.

For strand-specific library

| sens | anti | library | example | 
| -- | -- | -- | -- |
| -s 1 | -s 2 | `read1: ++ -- / read2: -- ++` | - | 
| -s 2 | -s 1 | `read1: +- ++ / read2: +- -+` | dUTP library, NSR library |


```{r lib type, results="asis"}
lib1 = "read1: ++ -- / read2: -- ++"
lib2 = "read1: +- ++ / read2: +- -+"
lib3 = "read1, read2, non-strand-specific"

f <- list_hiseq_file(input_dir, "strandness_json", "_rn")
s <- jsonlite::read_json(f)
a = switch(as.character(s$sense),
        "0" = {print(lib3)},
        "1" = {print(lib1)},
        "2" = {print(lib2)})
# print(a)
```

### 2.4 Quantification

```{r}
log2 <- glue::glue("Count reads on features:
                   Genome: {genome}
                      GTF: {basename(gtf)}")
print(log2)
```
**na**, indicate the `Not Assigned reads`.

```{r table2_sens_summary}
p4 <- plot_rnaseq_featureCounts(input_dir)
# show table
df4 <- p4$data %>%
  dplyr::select(sample, strand, count, Status, total) %>%
  tidyr::pivot_wider(names_from = strand, values_from = count) %>%
  dplyr::mutate(sens_pct = round(sense / total * 100, 1),
                anti_pct = round(anti / total * 100, 1),
                na_pct   = round(na / total * 100, 1))
hiseqr::to_DT(df4)
```


**na**, indicate the `Not Assigned reads`.
```{r count strand, fig.height=3}
print(p4)
```


### 2.5 Correlation between replicates

#### 1 Distribution of reads on gene body

#### 2 Correlation - PCA

#### 3 Correlation - heatmap

```{r}
g1 <- list_hiseq_file(input_dir, "genebody_enrich_png", "_rn")
g2 <- list_hiseq_file(input_dir, "bam_cor_pca_png", "_rn")
g3 <- list_hiseq_file(input_dir, "bam_cor_heatmap_png", "_rn")
g  <- purrr::keep(c(g1, g2, g3), file.exists)
if(file.exists(g)) {
  include_graphics(g)
}
```

**END**


