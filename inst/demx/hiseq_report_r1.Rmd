---
title: "Demx report"
author: "Ming Wang"
date: "`r Sys.Date()`"
output:
  html_document:
    highlight: tango
    toc: yes
    toc_float:
      collapsed: no
    keep_md: false
  word_document:
    toc: yes
  pdf_document:
    toc: yes
params:
  input_dir: "" # output of demx
---


```{r setup, include=FALSE}
suppressPackageStartupMessages(library(knitr))

knitr::opts_chunk$set(fig.width  = 12, 
                      fig.height = 8, 
                      fig.path   = "Figures/",
                      eval       = TRUE,
                      echo       = FALSE,
                      cache      = FALSE,
                      prompt     = FALSE,
                      tidy       = FALSE,
                      comment    = NA,
                      message    = FALSE,
                      warning    = FALSE,
                      eval       = T,
                      rownames.print = FALSE)
```


```{r load pkg}
library(hiseqr)
library(knitr)
library(ggplot2)
library(dplyr)
library(glue)
library(DT)
library(plotly)
library(jsonlite)
```


```{r config, eval = T}
input_dir    <- params$input_dir
input_dir    <- normalizePath(input_dir)
if(! is_hiseq_dir(input_dir, "demx")) {
  stop(paste0("Input file is not demx directory: ", input_dir))
}
```


```{r loading data}
s <- list_hiseq_file(input_dir, "sample_sheet", "r1")
if(file.exists(s)) {
  if(endsWith(s, ".xlsx")) {
    dx <- readxl::read_excel(s, sheet = "sample_sheet")
    df1 <- dx %>%
      dplyr::filter(! is.na(`Sample_name*`)) %>%
      dplyr::rename(filename = `Sample_name*`,
                    read_exp = `Reads, M`) %>%
      dplyr::select(filename, read_exp)
  } else if(endsWith(s, ".csv")) {
    df1 <- readr::read_csv(
      s, 
      col_names = c("filename", "i7", "i5", "bc", "read_exp")) %>%
      dplyr::select(filename, read_exp)
  } else {
    df1 <- NULL
  }
}else {
  df1 <- NULL
}

# load demx output
j <- list_hiseq_file(input_dir, "read_count_json")
if(file.exists(j)) {
  df2 <- jsonlite::read_json(j) %>%
    as.data.frame() %>%
    tidyr::pivot_longer(everything(),
                        names_to = "filename",
                        values_to = "count") %>%
    dplyr::mutate(million = round(count / 1e6, 1))
} else {
  df2 <- NULL
}

## update expect
if(is(df1, "data.frame")) {
  df <- merge(df2, df1, by = "filename", all.x = TRUE)
} else {
  df <- df2 %>%
    dplyr::mutate(read_exp = 1) # $read_exp = 3 # test
}

## remove NA
df$read_exp <- tidyr::replace_na(df$read_exp, 1)
```


```{r, results="asis"}
n_exp   <- sum(df$read_exp)
n_total <- sum(df$million)
n_pct   <- round(n_total / n_exp * 100, 1)
## demx, sample
n_demx  <- dplyr::filter(df, filename == "undemx") %>% dplyr::pull(million)
n_demx_pct <- round(n_demx / n_total * 100, 1)
n_smp   <- n_total - n_demx
n_smp_pct <- 100 - n_demx_pct
##
msg <- glue::glue("Total reads: `{n_total} M` (expect: {n_exp}M, {n_pct}% ouptut); Assigned to samples: {n_smp} M ({n_smp_pct}%); Not assigned to samples: {n_demx}M, ({n_demx_pct}%)")
print(msg)
```


## 1 Summary

Demultiplex, do not allow mismatches (`mm = 1`)

```{r, results="asis", eval = FALSE}
t1 <- sum(df$million)
u1 <- dplyr::filter(df, filename == "undemx") %>% dplyr::pull(million)
a1 <- t1 - u1
u1_pct <- round(u1 / t1 * 100, 1)
a1_pct <- 100 - u1_pct
msg <- glue::glue("Total reads: {t1} M; assigned to samples: {a1} M ({a1_pct}%); Not assigned to samples: {u1} M, ({u1_pct}%)")
print(msg)
```


## 2 Warning (< 1M samples)

**Caution**: The following samples contains less than 1M reads.

```{r, eval = TRUE}
df %>%
  dplyr::filter(million < 1) %>%
  hiseqr::to_DT(mode = 1)
```


## 3 Table

```{r}
hiseqr::to_DT(df, mode = 1, pageLength = 40)
```


## 4 Distribution

```{r, fig.height = 8, fig.width=8, eval = FALSE}
library(plotly)
  
plot_ly(df, y = ~filename, x = ~million, type = "bar", 
        text = ~million, 
        textposition = "auto",
        hoverinfo = "text",
        hovertemplate = "%{text}M, %{y}") %>%
  layout(yaxis = list(autorange = "reversed"))
```


The blue dotted lines, indicate the expect number of reads (15M, 20M).

```{r, fig.height = 8, fig.width = 8}
df %>%
  dplyr::filter(! grepl("undemx", filename)) %>%
bar_plot("million", "filename", label = "million", direction = "horizontal") +
  geom_vline(xintercept = c(3, 10, 15), linetype = 2, size = .5, color = "blue")
```


**END**
